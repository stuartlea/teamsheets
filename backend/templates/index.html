<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rugby Team Sheet Sidecar</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.js"></script>
    <script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.min.js"></script>
    <style>
        .team-sheet-svg {
            /* Slightly larger base size for better on-screen and export resolution */
            width: 1000px;
            height: 1250px;
            background: linear-gradient(135deg, #064e3b 0%, #047857 100%);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const TeamPlanTable = ({ periods, templateType }) => {
            if (!periods || Object.keys(periods).length <= 1) return null;

            // Sort periods by key (1, 2, 3...)
            const sortedPeriods = Object.keys(periods).sort((a,b) => parseInt(a) - parseInt(b)).map(k => parseInt(k));
            
            // Helper to get player at period/position
            const getPlayer = (periodNum, pos, isStarter) => {
                const pData = periods[periodNum];
                if (!pData) return null;
                const list = isStarter ? pData.starters : pData.finishers;
                // Starters index = pos-1. Finishers index = pos-16
                const idx = isStarter ? pos - 1 : pos - 16;
                if (!list || idx < 0 || idx >= list.length) return null;
                return list[idx];
            };

            // Badge/Color Logic for POS column
            const getPosColor = (periodNum, player, pos, isStarter) => {
                // Default: White/Transparent
                if (periodNum === 1) return ''; 
                if (!player || !player.name) return '';

                const prevPeriod = periods[periodNum - 1];
                if (!prevPeriod) return '';

                let wasStarterPrev = false;
                let prevPos = -1;

                prevPeriod.starters.forEach((s, i) => {
                    if (s.name === player.name) {
                        wasStarterPrev = true;
                        prevPos = i + 1;
                    }
                });

                // ON: Was not a starter previously, now is a starter
                if (isStarter && !wasStarterPrev) return 'bg-green-500 text-white';

                // SW: Was a starter previously, but at different position
                if (isStarter && wasStarterPrev && prevPos !== pos) return 'bg-yellow-500 text-white';

                // OFF: Is now valid Finisher (Bench), but was Starter previously
                if (!isStarter && wasStarterPrev) return 'bg-red-500 text-white';

                return '';
            };

            // Period Headers
            let periodLabels = [];
            if (templateType && templateType.includes('Thirds')) periodLabels = ['1st Third', '2nd Third', '3rd Third'];
            else if (templateType && templateType.includes('Quarters')) periodLabels = ['1st Quarter', '2nd Quarter', '3rd Quarter', '4th Quarter'];
            else if (templateType && templateType.includes('Halves')) periodLabels = ['1st Half', '2nd Half'];
            else periodLabels = sortedPeriods.map(p => `Period ${p}`);

            // Dynamic Row Logic for Finishers
            // Check positions 16 up to 30 to see if they are used in ANY period
            const maxCheck = 30;
            const activeSubPositions = [];
            for (let i = 16; i <= maxCheck; i++) {
                const isUsed = sortedPeriods.some(p => {
                    const player = getPlayer(p, i, false);
                    return player && player.name;
                });
                if (isUsed) activeSubPositions.push(i);
            }
            // If no subs found at all, maybe show at least 16-20? 
            // The user said "Id rather not see empty rows", so strict filtering is best. 
            // But if ALL are empty, show nothing or just the header? 
            // Let's assume strict filtering.

            return (
                <div className="mt-8 mb-12 overflow-x-auto w-auto max-w-[1200px] mx-auto bg-white p-6 rounded-lg shadow">
                    <table className="min-w-full border-collapse border border-gray-400 text-sm">
                        <thead>
                            <tr className="bg-blue-800 text-white">
                                {/* Removed first Pos col */}
                                {sortedPeriods.map((p, i) => (
                                    <React.Fragment key={p}>
                                        <th className={`border border-gray-400 p-2 text-center w-10 font-bold bg-blue-700 ${i === 0 || i > 0 ? 'border-l-4 border-l-gray-600' : ''}`}>Pos</th>
                                        <th className="border border-gray-400 p-2 text-left font-bold">
                                            {periodLabels[i] || `Period ${p}`}
                                        </th>
                                    </React.Fragment>
                                ))}
                            </tr>
                        </thead>
                        <tbody>
                            {/* Starters 1-15 */}
                            {Array.from({length: 15}, (_, i) => i + 1).map(pos => (
                                <tr key={pos} className={pos % 2 === 0 ? "bg-gray-50" : "bg-white"}>
                                    {/* Removed first Pos col */}
                                    {sortedPeriods.map((p, i) => {
                                        const player = getPlayer(p, pos, true);
                                        const colorClass = getPosColor(p, player, pos, true);
                                        const isFirstCol = true; // Apply thick border to every period start?
                                        
                                        return (
                                            <React.Fragment key={p}>
                                                <td className={`border border-gray-400 p-1 text-center font-bold text-xs ${colorClass} border-l-4 border-l-gray-600`}>
                                                    {pos}
                                                </td>
                                                <td className="border border-gray-400 p-1 px-3 h-8 text-gray-800 font-medium whitespace-nowrap overflow-hidden text-ellipsis max-w-[140px]">
                                                    {player ? player.name : ''}
                                                </td>
                                            </React.Fragment>
                                        );
                                    })}
                                </tr>
                            ))}
                            
                            {/* Divider Row for Bench */}
                             <tr className="bg-orange-100 border-t-2 border-gray-800">
                                {sortedPeriods.map((p, i) => (
                                    <React.Fragment key={p}>
                                        <td className="border border-gray-400 bg-orange-200 text-center font-bold text-xs border-l-4 border-l-gray-600">Sub</td>
                                        <td className="border border-gray-400 bg-orange-100"></td>
                                    </React.Fragment>
                                ))}
                            </tr>

                            {/* Finishers Rows (Dynamic) */}
                            {activeSubPositions.map(pos => (
                                <tr key={pos} className="bg-yellow-50">
                                    {sortedPeriods.map((p, i) => {
                                        const player = getPlayer(p, pos, false);
                                        const colorClass = getPosColor(p, player, pos, false);
                                        
                                         // If name is empty in THIS period, show empty cells
                                         // But we know this ROW is active because some period has a name
                                        if (!player || !player.name) {
                                             return (
                                                <React.Fragment key={p}>
                                                    <td className="border border-gray-400 bg-gray-50 border-l-4 border-l-gray-600"></td>
                                                    <td className="border border-gray-400 bg-gray-50"></td>
                                                </React.Fragment>
                                            );
                                        }
                                        
                                        return (
                                            <React.Fragment key={p}>
                                                <td className={`border border-gray-400 p-1 text-center font-bold text-xs ${colorClass} border-l-4 border-l-gray-600`}>
                                                    {pos}
                                                </td>
                                                <td className="border border-gray-400 p-1 px-3 h-8 text-gray-800 font-medium whitespace-nowrap overflow-hidden text-ellipsis max-w-[140px]">
                                                    {player.name}
                                                </td>
                                            </React.Fragment>
                                        );
                                    })}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };

        const TeamsManager = () => {
            const [teams, setTeams] = useState([]);
            const [seasons, setSeasons] = useState([]);
            const [contexts, setContexts] = useState([]);
            const [activeTab, setActiveTab] = useState('overview'); // overview, players, fixtures
            const [newTeamName, setNewTeamName] = useState('');
            const [selectedTeam, setSelectedTeam] = useState(null);
            const [newSeasonId, setNewSeasonId] = useState('');
            const [newSpreadsheetId, setNewSpreadsheetId] = useState('');

            useEffect(() => {
                fetchTeams();
                fetchSeasons();
                fetchContexts();
            }, []);

            const fetchTeams = async () => {
                const res = await fetch('/api/teams');
                const data = await res.json();
                if (data.success) setTeams(data.teams);
            };

            const fetchSeasons = async () => {
                const res = await fetch('/api/seasons');
                const data = await res.json();
                if (data.success) setSeasons(data.seasons);
            };

            const fetchContexts = async () => {
                 const res = await fetch('/api/contexts');
                 const data = await res.json();
                 if (data.success) setContexts(data.contexts);
            };

            const handleAddTeam = async () => {
                if (!newTeamName.trim()) return;
                const res = await fetch('/api/teams', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name: newTeamName})
                });
                const data = await res.json();
                if (data.success) {
                    setTeams([...teams, data.team]);
                    setNewTeamName('');
                } else {
                    alert(data.error);
                }
            };

            const handleLinkSeason = async () => {
                if (!selectedTeam || !newSeasonId || !newSpreadsheetId) return;
                const res = await fetch('/api/team-seasons', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        team_id: selectedTeam.id,
                        season_id: newSeasonId,
                        spreadsheet_id: newSpreadsheetId
                    })
                });
                const data = await res.json();
                if (data.success) {
                    alert('Linked successfully!');
                    fetchContexts();
                    // window.location.reload(); // No need to reload if we fetch contexts
                } else {
                    alert(data.error);
                }
            };

            const handleDeleteContext = async (id) => {
                if(!confirm('Are you sure you want to remove this link?')) return;
                const res = await fetch(`/api/team-seasons/${id}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                if (data.success) {
                    fetchContexts();
                } else {
                    alert('Failed to delete');
                }
            };

            // Player Logic
            const [players, setPlayers] = useState([]);
            const [newPlayerName, setNewPlayerName] = useState('');

            useEffect(() => {
                if (activeTab === 'players') fetchPlayers();
            }, [activeTab]);

            const fetchPlayers = async () => {
                const res = await fetch('/api/players');
                const data = await res.json();
                if (data.success) setPlayers(data.players);
            };

            const handleAddPlayer = async () => {
                if (!newPlayerName.trim()) return;
                const res = await fetch('/api/players', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name: newPlayerName})
                });
                const data = await res.json();
                if (data.success) {
                    setPlayers([...players, data.player]);
                    setNewPlayerName('');
                } else {
                    alert(data.error);
                }
            };

            const handleDeletePlayer = async (id) => {
                if(!confirm('Delete player? This might affect historic selections if not careful.')) return;
                const res = await fetch(`/api/players/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    setPlayers(players.filter(p => p.id !== id));
                }
            };

            // Fixture Logic
            const [fixtures, setFixtures] = useState([]);
            const [newFixtureDate, setNewFixtureDate] = useState('');
            const [newFixtureOpponent, setNewFixtureOpponent] = useState('');
            const [newFixtureVenue, setNewFixtureVenue] = useState('Home');

            useEffect(() => {
                // Determine context for fixtures
                if (activeTab === 'fixtures' && selectedTeam) {
                     const teamContext = contexts.find(c => c.team.id === selectedTeam.id);
                     if (teamContext) {
                         fetchFixtures(teamContext.id);
                     } else {
                         setFixtures([]); 
                     }
                }
            }, [activeTab, selectedTeam, contexts]);

            const fetchFixtures = async (tsId) => {
                const res = await fetch(`/api/fixtures?team_season_id=${tsId}`);
                const data = await res.json();
                if (data.success) setFixtures(data.fixtures);
            };

            const handleAddFixture = async () => {
                const teamContext = contexts.find(c => c.team.id === selectedTeam.id);
                if (!teamContext) {
                    alert('Please link a season first to add fixtures.');
                    return;
                }
                if (!newFixtureDate || !newFixtureOpponent) return;

                const res = await fetch('/api/fixtures', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        team_season_id: teamContext.id,
                        date: newFixtureDate,
                        name: newFixtureOpponent, 
                        home_away: newFixtureVenue
                    })
                });
                const data = await res.json();
                if (data.success) {
                    setFixtures([...fixtures, data.fixture].sort((a,b) => new Date(a.date) - new Date(b.date)));
                    setNewFixtureDate('');
                    setNewFixtureOpponent('');
                } else {
                    alert(data.error);
                }
            };

            const handleDeleteFixture = async (id) => {
                if(!confirm('Delete fixture?')) return;
                const res = await fetch(`/api/fixtures/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    setFixtures(fixtures.filter(f => f.id !== id));
                }
            };

            return (
                <div>
                    <h2 className="text-xl font-semibold mb-6">Team Management</h2>
                    
                    <div className="flex gap-4 mb-8 bg-gray-50 p-4 rounded-lg">
                        <input 
                            type="text" 
                            placeholder="New Team Name (e.g. U14s)" 
                            className="flex-1 border p-2 rounded"
                            value={newTeamName}
                            onChange={(e) => setNewTeamName(e.target.value)}
                        />
                        <button 
                            onClick={handleAddTeam}
                            className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                        >
                            Create Team
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {/* Team List */}
                        <div className="col-span-1 border-r pr-6">
                            <h3 className="font-bold mb-4 text-gray-700">Teams</h3>
                            <ul className="space-y-2">
                                {teams.map(t => (
                                    <li 
                                        key={t.id} 
                                        onClick={() => setSelectedTeam(t)}
                                        className={`p-3 rounded cursor-pointer border ${selectedTeam && selectedTeam.id === t.id ? 'bg-blue-50 border-blue-500' : 'bg-white hover:bg-gray-50 border-gray-200'}`}
                                    >
                                        <div className="font-medium">{t.name}</div>
                                    </li>
                                ))}
                            </ul>
                        </div>

                        {/* Team Details / Linking */}
                        <div className="col-span-2">
                            {selectedTeam ? (
                                <div>
                                    <h3 className="font-bold mb-4 text-gray-700">Manage {selectedTeam.name}</h3>
                                    
                                    {/* Tabs */}
                                    <div className="flex border-b border-gray-200 mb-6">
                                        <button
                                            onClick={() => setActiveTab('overview')}
                                            className={`py-2 px-4 font-medium text-sm border-b-2 transition-colors ${activeTab === 'overview' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                                        >
                                            Overview
                                        </button>
                                        <button
                                            onClick={() => setActiveTab('players')}
                                            className={`py-2 px-4 font-medium text-sm border-b-2 transition-colors ${activeTab === 'players' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                                        >
                                            Players
                                        </button>
                                        <button
                                            onClick={() => setActiveTab('fixtures')}
                                            className={`py-2 px-4 font-medium text-sm border-b-2 transition-colors ${activeTab === 'fixtures' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                                        >
                                            Fixtures
                                        </button>
                                        <button
                                            onClick={() => setActiveTab('source_data')}
                                            className={`py-2 px-4 font-medium text-sm border-b-2 transition-colors ${activeTab === 'source_data' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                                        >
                                            Source Data
                                        </button>
                                    </div>

                                    {activeTab === 'overview' && (
                                        <div className="space-y-6">
                                            {/* Stats Cards */}
                                            {contexts.filter(c => c.team.id === selectedTeam.id).map(ctx => (
                                                <div key={ctx.id} className="bg-white border rounded-lg p-6 shadow-sm">
                                                    <div className="flex justify-between items-start mb-4">
                                                        <div>
                                                            <h4 className="text-lg font-bold text-gray-800">{ctx.season.name} Season</h4>
                                                            <p className="text-sm text-gray-500">Spreadsheet Linked</p>
                                                        </div>
                                                        <span className="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-medium">Active</span>
                                                    </div>
                                                    
                                                    <div className="grid grid-cols-2 gap-4 mb-6">
                                                        <div className="bg-gray-50 p-4 rounded text-center">
                                                            <div className="text-2xl font-bold text-blue-600">{ctx.stats?.player_count || 0}</div>
                                                            <div className="text-xs text-gray-500 uppercase font-bold">Players</div>
                                                        </div>
                                                        <div className="bg-gray-50 p-4 rounded text-center">
                                                            <div className="text-2xl font-bold text-purple-600">{ctx.stats?.fixture_count || 0}</div>
                                                            <div className="text-xs text-gray-500 uppercase font-bold">Fixtures</div>
                                                        </div>
                                                    </div>

                                                    {/* Next Fixture Card */}
                                                    {ctx.stats?.next_fixture ? (
                                                        <div className="border border-blue-200 bg-blue-50 rounded p-4">
                                                            <h5 className="text-sm font-bold text-blue-800 mb-2 uppercase">Next Fixture</h5>
                                                            <div className="flex justify-between items-center">
                                                                <div>
                                                                    <div className="font-bold text-lg">{ctx.stats.next_fixture.name}</div>
                                                                    <div className="text-sm text-gray-600">
                                                                        {new Date(ctx.stats.next_fixture.date).toLocaleDateString()} â€¢ {ctx.stats.next_fixture.home_away}
                                                                    </div>
                                                                </div>
                                                                <button
                                                                    onClick={() => window.location.href = `/?context_id=${ctx.id}&match_id=${ctx.stats.next_fixture.id}`}
                                                                    className="bg-blue-600 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-700 shadow-sm"
                                                                >
                                                                    Generate Sheet
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <div className="text-center p-4 bg-gray-50 rounded border border-dashed border-gray-300 text-gray-500 text-sm">
                                                            No upcoming fixtures found.
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                            
                                            {contexts.filter(c => c.team.id === selectedTeam.id).length === 0 && (
                                                <div className="p-8 text-center bg-gray-50 rounded border border-dashed">
                                                    <p className="text-gray-500 mb-4">No active seasons linked yet.</p>
                                                    <button 
                                                        onClick={() => setActiveTab('source_data')}
                                                        className="text-blue-600 hover:underline"
                                                    >
                                                        Link a Spreadsheet in Source Data
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {activeTab === 'source_data' && (
                                        <div>
                                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-6">
                                                <h4 className="font-medium text-blue-800 mb-2">Link to a Season</h4>
                                                <div className="space-y-3">
                                            <div>
                                                <label className="block text-xs font-bold text-gray-500 uppercase">Season</label>
                                                <select 
                                                    className="w-full p-2 border rounded"
                                                    value={newSeasonId}
                                                    onChange={e => setNewSeasonId(e.target.value)}
                                                >
                                                    <option value="">Select Season...</option>
                                                    {seasons.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-gray-500 uppercase">Google Sheet ID</label>
                                                <input 
                                                    type="text" 
                                                    className="w-full p-2 border rounded text-sm font-mono"
                                                    placeholder="1KRCwRuvTR0DXaNT..."
                                                    value={newSpreadsheetId}
                                                    onChange={e => setNewSpreadsheetId(e.target.value)}
                                                />
                                            </div>
                                            <button 
                                                onClick={handleLinkSeason}
                                                className="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700"
                                            >
                                                Link Spreadsheet
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div className="mb-6">
                                        <h4 className="font-bold mb-3 text-gray-700">Linked Seasons</h4>
                                        {contexts.filter(c => c.team.id === selectedTeam.id).length > 0 ? (
                                            <div className="bg-white border rounded overflow-hidden">
                                                <table className="min-w-full divide-y divide-gray-200">
                                                    <thead className="bg-gray-50">
                                                        <tr>
                                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Season</th>
                                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Spreadsheet ID</th>
                                                            <th className="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-gray-200">
                                                        {contexts.filter(c => c.team.id === selectedTeam.id).map(ctx => (
                                                            <tr key={ctx.id}>
                                                                <td className="px-4 py-2 text-sm font-medium text-gray-900">{ctx.season.name}</td>
                                                                <td className="px-4 py-2 text-sm text-gray-500 font-mono truncate max-w-[150px]" title={ctx.spreadsheet_id}>
                                                                    {ctx.spreadsheet_id.substring(0, 10)}...
                                                                </td>
                                                                <td className="px-4 py-2 text-right text-sm">
                                                                    <button 
                                                                        onClick={() => handleDeleteContext(ctx.id)}
                                                                        className="text-red-600 hover:text-red-900 ml-2"
                                                                    >
                                                                        Delete
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        ) : (
                                            <p className="text-gray-500 text-sm italic">No seasons linked yet.</p>
                                        )}
                                    </div>

                                        </div>
                                    )}

                                    {activeTab === 'players' && (
                                        <div>
                                            <div className="flex gap-2 mb-4">
                                                <input 
                                                    type="text" 
                                                    className="border p-2 rounded flex-1"
                                                    placeholder="Player Name"
                                                    value={newPlayerName}
                                                    onChange={e => setNewPlayerName(e.target.value)}
                                                />
                                                <button 
                                                    onClick={handleAddPlayer}
                                                    className="bg-green-600 text-white px-4 rounded hover:bg-green-700"
                                                >
                                                    Add Player
                                                </button>
                                            </div>
                                            
                                            <div className="bg-white border rounded overflow-hidden max-h-[400px] overflow-y-auto">
                                                <table className="min-w-full divide-y divide-gray-200">
                                                    <thead className="bg-gray-50 sticky top-0">
                                                        <tr>
                                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                                            <th className="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-gray-200">
                                                        {players.map(p => (
                                                            <tr key={p.id}>
                                                                <td className="px-4 py-2 text-sm text-gray-900">{p.name}</td>
                                                                <td className="px-4 py-2 text-right text-sm">
                                                                    <button 
                                                                        onClick={() => handleDeletePlayer(p.id)}
                                                                        className="text-red-600 hover:text-red-900"
                                                                    >
                                                                        Delete
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}

                                    {activeTab === 'fixtures' && (
                                        <div>
                                            {!contexts.find(c => c.team.id === selectedTeam.id) ? (
                                                <div className="text-amber-600 bg-amber-50 p-4 rounded mb-4">
                                                    Please link a Season in the Overview tab before managing fixtures.
                                                </div>
                                            ) : (
                                                <>
                                                    <div className="flex gap-2 mb-4">
                                                        <input 
                                                            type="date" 
                                                            className="border p-2 rounded"
                                                            value={newFixtureDate}
                                                            onChange={e => setNewFixtureDate(e.target.value)}
                                                        />
                                                        <input 
                                                            type="text" 
                                                            className="border p-2 rounded flex-1"
                                                            placeholder="Opponent (e.g. Leek)"
                                                            value={newFixtureOpponent}
                                                            onChange={e => setNewFixtureOpponent(e.target.value)}
                                                        />
                                                        <select
                                                            className="border p-2 rounded"
                                                            value={newFixtureVenue}
                                                            onChange={e => setNewFixtureVenue(e.target.value)}
                                                        >
                                                            <option value="Home">Home</option>
                                                            <option value="Away">Away</option>
                                                        </select>
                                                        <button 
                                                            onClick={handleAddFixture}
                                                            className="bg-green-600 text-white px-4 rounded hover:bg-green-700"
                                                        >
                                                            Add
                                                        </button>
                                                    </div>
                                                    
                                                    <div className="bg-white border rounded overflow-hidden max-h-[400px] overflow-y-auto">
                                                        <table className="min-w-full divide-y divide-gray-200">
                                                            <thead className="bg-gray-50 sticky top-0">
                                                                <tr>
                                                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Opponent</th>
                                                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Venue</th>
                                                                    <th className="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody className="divide-y divide-gray-200">
                                                                {fixtures.map(f => (
                                                                    <tr key={f.id}>
                                                                        <td className="px-4 py-2 text-sm text-gray-900">{f.date}</td>
                                                                        <td className="px-4 py-2 text-sm font-medium">{f.name}</td>
                                                                        <td className="px-4 py-2 text-sm text-gray-500">
                                                                            <span className={`px-2 py-1 rounded text-xs ${f.home_away === 'Home' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}`}>
                                                                                {f.home_away}
                                                                            </span>
                                                                        </td>
                                                                        <td className="px-4 py-2 text-right text-sm whitespace-nowrap">
                                                                            <button 
                                                                                onClick={() => {
                                                                                    // Find context for this team
                                                                                    const ctx = contexts.find(c => c.team.id === selectedTeam.id);
                                                                                    if (ctx) {
                                                                                        window.location.href = `/?context_id=${ctx.id}&match_id=${f.id}`;
                                                                                    }
                                                                                }}
                                                                                className="text-blue-600 hover:text-blue-900 mr-3"
                                                                                title="Generate Team Sheet"
                                                                            >
                                                                                Gen
                                                                            </button>
                                                                            <button 
                                                                                onClick={() => handleDeleteFixture(f.id)}
                                                                                className="text-red-600 hover:text-red-900"
                                                                            >
                                                                                Delete
                                                                            </button>
                                                                        </td>
                                                                    </tr>
                                                                ))}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    )}

                                    <div className="text-sm text-gray-500 mt-6 pt-6 border-t">
                                        <p>Select a context in the header to view existing links/data.</p>
                                    </div>
                                </div>
                            ) : (
                                <div className="text-gray-400 text-center py-10">Select a team to manage details</div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                
                try {
                    const res = await fetch('/api/login', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ username, password })
                    });
                    const data = await res.json();
                    
                    if (data.success) {
                        onLogin(data.user);
                    } else {
                        setError(data.message || 'Login failed');
                    }
                } catch (err) {
                    setError('Network error occurred');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100">
                    <div className="bg-white p-8 rounded shadow-md w-full max-w-md">
                        <h1 className="text-2xl font-bold mb-6 text-center text-gray-800">Rugby Team Manager</h1>
                        {error && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                                {error}
                            </div>
                        )}
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2">Username</label>
                                <input
                                    type="text"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                    required
                                />
                            </div>
                            <div className="mb-6">
                                <label className="block text-gray-700 text-sm font-bold mb-2">Password</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                    required
                                />
                            </div>
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline disabled:opacity-50"
                            >
                                {loading ? 'Logging in...' : 'Sign In'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        function TeamSheetApp() {
            const [teamData, setTeamData] = useState(null);
            // loading/error moved to top
            const [featuredImage, setFeaturedImage] = useState(null);
            const [featuredPlayer, setFeaturedPlayer] = useState('');
            const [featuredLabelType, setFeaturedLabelType] = useState('Captain');
            const [featuredLabelCustom, setFeaturedLabelCustom] = useState('');
            const [nameFormat, setNameFormat] = useState('initial'); // 'full', 'surname', 'initial'
            const [kitText, setKitText] = useState('Number 1s'); // 'Number 1s', 'Polos', 'Custom'
            const [kitTextCustom, setKitTextCustom] = useState('');
            const [metadata, setMetadata] = useState({
                kickoff: '',
                meet_time: '',
                location: '',
                custom_title: 'SANDBACH RUFC U15s',
                match_date: ''
            });

            // Helper to parse opponent name from fixture title (e.g., "19: Chester (A)" â†’ "Chester")
            const parseOpponent = (fixtureName) => {
                if (!fixtureName) return '';
                // Match pattern: "NN: TeamName (H/A)"
                const match = fixtureName.match(/^\d+:\s*(.+?)\s*\([HA]\)$/i);
                return match ? match[1].trim() : fixtureName;
            };

            const formatDbDate = (dateStr) => {
                if (!dateStr) return '';
                const d = new Date(dateStr);
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                const dayName = days[d.getDay()];
                const dayNum = d.getDate();
                const month = months[d.getMonth()];
                const year = d.getFullYear();
                
                const ordinal = (n) => {
                    if (n > 3 && n < 21) return 'th';
                    switch (n % 10) {
                        case 1:  return "st";
                        case 2:  return "nd";
                        case 3:  return "rd";
                        default: return "th";
                    }
                };
                
                return `${dayName} ${dayNum}${ordinal(dayNum)} ${month} ${year}`;
            };

            // Form validation - all required fields must be filled
            const isFormValid = () => {
                if (!featuredPlayer) return false;
                if (!metadata.kickoff) return false;
                if (!metadata.meet_time) return false;
                if (!metadata.location) return false;
                if (metadata.location === 'Custom' && !metadata.custom_location) return false;
                if (!metadata.custom_title) return false;
                if (!metadata.match_date) return false;
                if (metadata.location === 'Custom' && !metadata.custom_location) return false;
                if (!metadata.custom_title) return false;
                if (!metadata.match_date) return false;
                if (kitText === 'Custom' && !kitTextCustom) return false;
                return true;
            };
            // view moved to top
            const [previewTab, setPreviewTab] = useState('sheet'); // 'sheet' or 'plan'
            // dbTab moved to top
            const [dbData, setDbData] = useState({matches: [], players: []});

            const [editingMatch, setEditingMatch] = useState(null);
            const [showEditModal, setShowEditModal] = useState(false);
            const [editFormData, setEditFormData] = useState({
                kickoff: '',
                meet_time: '',
                location: '',
                is_cancelled: false
            });

            const handleEditClick = (match) => {
                setEditingMatch(match);
                setEditFormData({
                    kickoff: match.kickoff || '',
                    meet_time: match.meet_time || '',
                    location: match.location || '',
                    is_cancelled: match.is_cancelled || false
                });
                setShowEditModal(true);
            };

            const handleKickoffChange = (e) => {
                const newKickoff = e.target.value;
                setEditFormData(prev => {
                    const newState = {...prev, kickoff: newKickoff};
                    
                    // Auto-calc meet time if empty (and valid HH:MM format)
                    if (!prev.meet_time && newKickoff.match(/^\d{1,2}:\d{2}$/)) {
                        const parts = newKickoff.split(':');
                        let h = parseInt(parts[0]);
                        const m = parts[1];
                        let meetH = h - 1;
                        // Simple 1 hour subtraction
                        const meetTime = `${meetH.toString().padStart(2, '0')}:${m}`;
                        newState.meet_time = meetTime;
                    }
                    return newState;
                });
            };

            const handleSaveMatch = async () => {
                if (!editingMatch) return;
                
                try {
                    const response = await fetch(`/api/db/match/${editingMatch.id}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(editFormData)
                    });
                    const data = await response.json();
                    if (data.success) {
                        setShowEditModal(false);
                        fetchDbData(); // Refresh list
                    } else {
                        alert('Error saving: ' + data.error);
                    }
                } catch (e) {
                    alert('Error saving: ' + e);
                }
            };
            
            const fetchDbData = async () => {
                setLoading(true);
                try {
                    const [matchesRes, playersRes] = await Promise.all([
                        fetch('/api/db/matches'),
                        fetch('/api/db/players')
                    ]);
                    const matches = await matchesRes.json();
                    const players = await playersRes.json();
                    setDbData({
                        matches: matches.matches || [],
                        players: players.players || []
                    });
                } catch (e) {
                    console.error("DB Fetch Error", e);
                } finally {
                    setLoading(false);
                }
            };

            // --- State Declarations ---
            // Auth State
            const [user, setUser] = useState(null);
            const [paramsChecked, setParamsChecked] = useState(false);
            
            // App State
            const [contexts, setContexts] = useState([]);
            const [activeContext, setActiveContext] = useState(null);
            const [view, setView] = useState('teams'); // 'teams', 'generator', 'database'
            const [dbTab, setDbTab] = useState('matches'); // 'matches', 'players'
            const [players, setPlayers] = useState([]);
            const [matches, setMatches] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            
            // Generator State
            const [selectedWorksheet, setSelectedWorksheet] = useState('');
            const [worksheets, setWorksheets] = useState([]);
            const [starters, setStarters] = useState([]);
            const [finishers, setFinishers] = useState([]);
            const [fixtureInfo, setFixtureInfo] = useState(null);
            const [templateType, setTemplateType] = useState('15s'); 
            const [generatedImage, setGeneratedImage] = useState(null);
            const [matchMetadata, setMatchMetadata] = useState({
                kickoff: '15:00',
                meet_time: '13:30',
                location: 'Home'
            });
            const [playerImages, setPlayerImages] = useState({});

            // --- Handler Functions ---
            
            const fetchContexts = async () => {
                try {
                    const response = await fetch('/api/contexts');
                    const data = await response.json();
                    if (data.success && data.contexts.length > 0) {
                        setContexts(data.contexts);
                        // Default to current season or first avail
                        const current = data.contexts.find(c => c.season.is_current) || data.contexts[0];
                        setActiveContext(current);
                    }
                } catch (error) {
                    console.error('Error fetching contexts:', error);
                }
            };

            const handleLogin = (userData) => {
                setUser(userData);
                fetchContexts();
            };

            const handleLogout = async () => {
                await fetch('/api/logout', { method: 'POST' });
                setUser(null);
                setContexts([]);
                setActiveContext(null);
                setView('teams'); // Reset to team list
            };

            // --- Effects ---

            // Check auth status on load
            useEffect(() => {
                const checkAuth = async () => {
                    try {
                        const res = await fetch('/api/me');
                        const data = await res.json();
                        if (data.authenticated) {
                            setUser(data.user);
                            fetchContexts();
                        }
                    } catch (err) {
                        console.error("Auth check failed", err);
                    } finally {
                        setParamsChecked(true);
                    }
                };
                checkAuth();
            }, []);

            // Handle URL params
            useEffect(() => {
                if (user && contexts.length > 0) {
                    const params = new URLSearchParams(window.location.search);
                    const ctxId = params.get('context_id');
                    const mId = params.get('match_id');

                    if (ctxId) {
                        const ctx = contexts.find(c => c.id.toString() === ctxId);
                        if (ctx) {
                            setActiveContext(ctx);
                            if (mId) {
                                window._pendingMatchId = mId;
                            }
                        }
                    }
                }
            }, [contexts, user]);

            // Re-fetch fixtures when context changes
            useEffect(() => {
                if (activeContext) {
                    fetchWorksheets();
                }
            }, [activeContext]);

            // Effect to load all team images when starters change
            useEffect(() => {
                let isMounted = true;
                const loadTeamImages = async () => {
                   if (!dbData.matches || !dbData.matches.length) return;
                };
            }, [selectedWorksheet]);

            useEffect(() => {
                let isMounted = true;
                
                const fetchPlayerImage = async (playerName) => {
                    try {
                        const response = await fetch(`/api/player-image/${encodeURIComponent(playerName)}`);
                        const data = await response.json();
                        if (data.success && data.image_url) {
                            return data.image_url;
                        }
                    } catch (e) {
                        return null;
                    }
                    return null;
                };

                const loadAllImages = async () => {
                    if (!teamData || !teamData.starters) return;
                    
                    const newImages = {};
                    const promises = teamData.starters.map(async (player) => {
                        if (player && player.name) {
                            const url = await fetchPlayerImage(player.name);
                            // Ignore the backend's fallback silhouette PNG so we use the SVG symbol instead
                            if (url && !url.includes('player-silhouette.png')) {
                                newImages[player.name] = url;
                            }
                        }
                    });

                    await Promise.all(promises);
                    if (isMounted) {
                        setPlayerImages(prev => ({...prev, ...newImages}));
                    }
                };
                
                loadAllImages();
                
                return () => { isMounted = false; };
            }, [teamData]);

            useEffect(() => {
                let isMounted = true;

                const loadFeaturedImage = async () => {
                    if (!featuredPlayer) {
                        if (isMounted) setFeaturedImage(null);
                        return;
                    }

                    try {
                        const response = await fetch(`/api/player-image/${featuredPlayer}`);
                        const data = await response.json();
                        
                        if (!isMounted) return;

                        if (data.success && data.image_url) {
                            // Fetch the actual image to convert to data URL
                            const imgResponse = await fetch(data.image_url);
                            
                            if (!isMounted) return;

                            if (!imgResponse.ok) {
                                throw new Error('Image fetch failed');
                            }

                            const blob = await imgResponse.blob();
                            
                             if (!isMounted) return;

                            // Reject SVGs (likely placeholders) and non-images
                            if (!blob.type.startsWith('image/') || blob.type.includes('svg')) {
                                throw new Error('Invalid image type');
                            }

                            const reader = new FileReader();
                            reader.onloadend = () => {
                                if (!isMounted) return;
                                const dataUrl = reader.result;
                                // Reject fake PNGs (SVG/text disguised as PNG)
                                try {
                                    const base64 = dataUrl.split(',')[1];
                                    const decoded = atob(base64.substring(0, 100)); // Check first ~75 bytes
                                    if (decoded.startsWith('<!--') || decoded.startsWith('<svg') || decoded.startsWith('<?xml')) {
                                        console.warn('Rejected fake image (SVG/XML content in PNG)');
                                        setFeaturedImage(null);
                                        return;
                                    }
                                } catch (e) {
                                    // If decoding fails, reject
                                    setFeaturedImage(null);
                                    return;
                                }
                                setFeaturedImage(dataUrl);
                            };
                            reader.readAsDataURL(blob);
                        } else {
                            if (isMounted) setFeaturedImage(null);
                        }
                    } catch (error) {
                        console.error('Error loading featured image:', error);
                        if (isMounted) setFeaturedImage(null);
                    }
                };

                loadFeaturedImage();

                return () => {
                    isMounted = false;
                };
            }, [featuredPlayer]);

            // --- Conditional Rendering (MUST BE LAST) ---

            // If auth check is running
            if (!paramsChecked) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-slate-900 text-white">
                        <div className="text-xl">Loading Team Manager...</div>
                    </div>
                );
            }

            // If not authenticated, show login
            if (!user) {
                return <LoginScreen onLogin={handleLogin} />;
            }
            
            // --- Handlers requiring state ---
            // (Moving these up or ensuring they are defined)


            // State declarations moved to top

            // --- End Image Effects ---



            const fetchWorksheets = async () => {
                if (!activeContext) return;
                setLoading(true);
                try {
                    const response = await fetch(`/api/db/matches?team_season_id=${activeContext.id}`);
                    const data = await response.json();
                    if (data.success) {
                        setWorksheets(data.matches);
                        // Check for pending match selection from URL params
                        if (window._pendingMatchId) {
                            // Ensure ID types match (API usually returns numbers, URL params are strings)
                            // We compare loosely or ensure string conversion
                            const matchExists = data.matches.find(m => m.id.toString() === window._pendingMatchId.toString());
                            if (matchExists) {
                                setSelectedWorksheet(matchExists.id);
                                fetchTeamData(matchExists.id); // Trigger data load
                            }
                            window._pendingMatchId = null; // Clear to prevent re-selection
                        }
                    } else {
                        console.error('Failed to fetch fixtures from database');
                    }
                } catch (error) {
                    console.error('Error fetching worksheets:', error);
                } finally {
                    setLoading(false);
                }
            };

            const handleConnect = () => {
                window.location.href = '/auth/login';
            };
            
            // Duplicate handleLogout removed from here


            const handleSync = async () => {
                if (!activeContext) return;
                const btn = document.getElementById('sync-btn');
                const origText = btn.innerText;
                btn.innerText = 'Syncing...';
                btn.disabled = true;
                
                try {
                    const response = await fetch(`/api/sync?team_season_id=${activeContext.id}`);
                    const data = await response.json();
                    if (data.success) {
                        alert('Database Synchronized Successfully!');
                    } else {
                        alert('Sync Failed: ' + data.error);
                    }
                } catch (e) {
                    alert('Sync Error: ' + e);
                } finally {
                    btn.innerText = origText;
                    btn.disabled = false;
                }
            };

            const refreshTeamData = async () => {
                if (!selectedWorksheet) return;
                
                setLoading(true);
                setError('');
                try {
                    const response = await fetch(`/api/db/match/${selectedWorksheet}/refresh`, {
                        method: 'POST'
                    });
                    const data = await response.json();
                    if (data.success) {
                        // Re-fetch data
                        await fetchTeamData(selectedWorksheet);
                    } else {
                        setError(data.error || 'Refresh failed');
                    }
                } catch (error) {
                    console.error('Error refreshing team data:', error);
                    setError('Network error: Failed to refresh');
                } finally {
                    setLoading(false);
                }
            };

            const fetchTeamData = async (matchId) => {
                setLoading(true);
                setError('');
                // Don't clear team data immediately to avoid flash if refreshing
                // setTeamData(null); 
                // Reset featured player to force selection
                setFeaturedPlayer('');
                try {
                    const response = await fetch(`/api/db/match/${matchId}/team`);
                    const data = await response.json();
                    if (data.success) {
                        setTeamData(data);
                        // Featured player starts empty - user must select
                        setFeaturedPlayer('');
                        
                        // Auto-populate location if Home match
                        if (data.fixture_info) {
                            const homeAway = data.fixture_info.home_away && data.fixture_info.home_away.toLowerCase();
                            if (homeAway === 'home' || homeAway === 'h') {
                                setMetadata(prev => ({
                                    ...prev,
                                    location: 'Sandbach RUFC, Bradwall Road, Sandbach. CW11 1RA'
                                }));
                            }
                            
                            // Auto-populate match date if available
                            if (data.fixture_info.match_date) {
                                // Try to parse the date - format might vary
                                let dateStr = data.fixture_info.match_date;
                                // If it's in UK format (DD/MM/YYYY), convert to YYYY-MM-DD for input
                                if (dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                                    const parts = dateStr.split('/');
                                    dateStr = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                                }
                                setMetadata(prev => ({...prev, match_date: dateStr}));
                            }
                        }
                        
                        // Apply DB override metadata (Kickoff, Meet, Location, Cancellation)
                        if (data.metadata) {
                            setMetadata(prev => ({
                                ...prev,
                                ...data.metadata
                            }));
                        }
                    } else {
                        setError(data.error || 'Failed to load team data');
                    }
                } catch (error) {
                    console.error('Error fetching team data:', error);
                    setError('Network error: Failed to connect to server');
                } finally {
                    setLoading(false);
                }
            };

            const handleWorksheetChange = (e) => {
                const matchId = e.target.value;
                setSelectedWorksheet(matchId);
                setError(''); // Clear error when changing selection
                if (matchId) {
                    fetchTeamData(matchId);
                } else {
                    setTeamData(null);
                }
            };

            const exportImage = () => {
                // Export the full preview area rather than just the raw SVG to avoid cropping
                const target = document.getElementById('capture-area') || document.getElementById('team-sheet-svg');
                if (!target) {
                    console.error('Export target not found');
                    return;
                }

                htmlToImage
                    .toPng(target, {
                        cacheBust: true,
                        pixelRatio: 2, // 2x resolution export
                        imagePlaceholder: '/static/pitch-assets/player-silhouette.png', // Fallback
                        width: 1000,
                        height: 1250,
                        backgroundColor: '#022c22',
                    })
                    .then((dataUrl) => {
                        const link = document.createElement('a');
                        link.download = `team-sheet-${selectedWorksheet || 'export'}.png`;
                        link.href = dataUrl;
                        link.click();
                    })
                    .catch((error) => {
                        console.error('Error exporting image:', error);
                        alert('Error exporting image. Check console for details.');
                    });
            };

            const captureStyle = {
                width: '1000px',
                height: '1250px',
                flexShrink: 0,
                backgroundColor: '#022c22'
            };

            return (
                <div className="container mx-auto px-4 py-8">
                    <div className="flex justify-between items-center mb-8">
                        <div className="flex items-center space-x-6">
                            <h1 className="text-3xl font-bold text-gray-800">Rugby Team Sheet Generator</h1>
                            <div className="flex bg-gray-200 rounded-lg p-1">
                                <button 
                                    onClick={() => setView('generator')}
                                    className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${view === 'generator' ? 'bg-white text-gray-900 shadow' : 'text-gray-600 hover:text-gray-900'}`}
                                >
                                    Generator
                                </button>
                                <button 
                                    onClick={() => setView('database')}
                                    className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${view === 'database' ? 'bg-white text-gray-900 shadow' : 'text-gray-600 hover:text-gray-900'}`}
                                >
                                    Database
                                </button>
                                <button 
                                    onClick={() => setView('teams')}
                                    className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${view === 'teams' ? 'bg-white text-gray-900 shadow' : 'text-gray-600 hover:text-gray-900'}`}
                                >
                                    Teams
                                </button>
                            </div>
                        </div>
                        <div className="flex items-center space-x-4">
                            {contexts.length > 0 && (
                                <div className="mr-2">
                                    <select 
                                        value={activeContext ? activeContext.id : ''}
                                        onChange={(e) => {
                                            const ctx = contexts.find(c => c.id.toString() === e.target.value);
                                            setActiveContext(ctx);
                                        }}
                                        className="bg-white border border-gray-300 rounded px-3 py-1.5 text-sm text-gray-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                        {contexts.map(c => (
                                            <option key={c.id} value={c.id}>
                                                {c.team.name} ({c.season.name})
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            )}
                            {user ? (
                                <div className="flex items-center space-x-2">
                                    <button
                                        id="sync-btn"
                                        onClick={handleSync}
                                        className="bg-purple-600 text-white px-3 py-1 text-sm rounded-md hover:bg-purple-700 transition-colors mr-2"
                                    >
                                        Sync Database
                                    </button>
                                    <span className="text-green-600 font-medium">âœ“ Connected</span>
                                    <button
                                        onClick={handleLogout}
                                        className="text-red-600 hover:text-red-800 font-medium"
                                    >
                                        Logout
                                    </button>
                                </div>
                            ) : (
                                <button
                                    onClick={handleConnect}
                                    className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors"
                                >
                                    Connect to Google Sheets
                                </button>
                            )}
                        </div>
                    </div>
                    
                    {/* Main Content Area */}
                    {view === 'database' ? (
                        <div className="bg-white rounded-lg shadow-md p-6 mb-8 w-full">
                            <div className="border-b border-gray-200 mb-6">
                                <nav className="-mb-px flex space-x-8">
                                    <button
                                        onClick={() => setDbTab('matches')}
                                        className={`pb-4 px-1 border-b-2 font-medium text-sm ${dbTab === 'matches' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}
                                    >
                                        Matches
                                    </button>
                                    <button
                                        onClick={() => setDbTab('players')}
                                        className={`pb-4 px-1 border-b-2 font-medium text-sm ${dbTab === 'players' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}
                                    >
                                        Players
                                    </button>
                                </nav>
                            </div>
                            
                            {dbTab === 'matches' && (
                                <div className="overflow-x-auto">
                                    <table className="min-w-full divide-y divide-gray-200">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Context</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fixture</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Venue</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kickoff</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody className="bg-white divide-y divide-gray-200">
                                            {dbData.matches.length > 0 ? (
                                                dbData.matches.map((match) => {
                                                    const ctx = contexts.find(c => c.id === match.team_season_id);
                                                    return (
                                                    <tr key={match.id} className={match.is_cancelled ? "bg-red-50" : "hover:bg-gray-50"}>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                            {ctx ? (
                                                                <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                                                    {ctx.team.name} <span className="text-gray-500 ml-1">({ctx.season.name})</span>
                                                                </span>
                                                            ) : '-'}
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                            {formatDbDate(match.date)}
                                                            {match.is_cancelled && <span className="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">Cancelled</span>}
                                                        </td>
                                                        <td className={`px-6 py-4 whitespace-nowrap text-sm font-medium ${match.is_cancelled ? 'text-gray-500 line-through' : 'text-gray-900'}`}>{match.name}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{match.home_away}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{match.kickoff}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                            <button 
                                                                onClick={() => handleEditClick(match)}
                                                                className="text-indigo-600 hover:text-indigo-900"
                                                            >
                                                                Edit
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    );
                                                })
                                            ) : (
                                                <tr>
                                                    <td colSpan="5" className="px-6 py-4 text-center text-sm text-gray-500">No matches found. Try syncing the database.</td>
                                                </tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                            
                            {dbTab === 'players' && (
                                <div className="overflow-x-auto">
                                    <table className="min-w-full divide-y divide-gray-200">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Caps (Selections)</th>
                                            </tr>
                                        </thead>
                                        <tbody className="bg-white divide-y divide-gray-200">
                                            {dbData.players.length > 0 ? (
                                                dbData.players.map((player) => (
                                                    <tr key={player.id} className="hover:bg-gray-50">
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{player.name}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{player.caps}</td>
                                                    </tr>
                                                ))
                                            ) : (
                                                <tr>
                                                    <td colSpan="2" className="px-6 py-4 text-center text-sm text-gray-500">No players found. Try syncing the database.</td>
                                                </tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    ) : view === 'teams' ? (
                        <div className="bg-white rounded-lg shadow-md p-6 mb-8 w-full">
                           <TeamsManager />
                        </div>
                    ) : (
                        /* Generator View */
                        <div>
                        <div className="bg-white rounded-lg shadow-md p-6 mb-8">
                            <h2 className="text-xl font-semibold mb-4">Team Selection</h2>
                                
                                {!user && (
                                    <div className="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-md">
                                        <p className="text-yellow-800 text-sm">
                                            Connect to Google Sheets to access your team data. Using mock data for demonstration.
                                        </p>
                                    </div>
                                )}
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {/* Left Column */}
                                    <div>
                                        <div className="mb-4">
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Select Fixture
                                            </label>
                                        <div className="flex gap-2">
                                            <select
                                                value={selectedWorksheet}
                                                onChange={handleWorksheetChange}
                                                className="flex-1 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                            >
                                                <option value="">Choose a fixture...</option>
                                                {worksheets.map(match => (
                                                    <option key={match.id} value={match.id}>
                                                        {match.name} {match.is_cancelled ? '(Cancelled)' : ''}
                                                    </option>
                                                ))}
                                            </select>
                                            <button
                                                onClick={refreshTeamData}
                                                disabled={!selectedWorksheet || loading}
                                                className="bg-blue-100 text-blue-700 p-2 rounded-md hover:bg-blue-200 disabled:opacity-50"
                                                title="Refresh data from Google Sheet"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                    <path d="M21 2v6h-6"></path>
                                                    <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
                                                    <path d="M3 22v-6h6"></path>
                                                    <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>

                                    {error && (
                                        <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-md">
                                            <p className="text-red-800 text-sm">{error}</p>
                                        </div>
                                    )}

                                    {teamData && (
                                        <React.Fragment>
                                            <div className="mb-4">
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Featured Label
                                                </label>
                                                <select
                                                    value={featuredLabelType}
                                                    onChange={(e) => setFeaturedLabelType(e.target.value)}
                                                    className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500 mb-2"
                                                >
                                                    <option value="Featured Star">Featured Star</option>
                                                    <option value="Captain">Captain</option>
                                                    <option value="Man of the Match">Man of the Match</option>
                                                    <option value="Custom">Custom...</option>
                                                </select>
                                                
                                                {featuredLabelType === 'Custom' && (
                                                    <input
                                                        type="text"
                                                        value={featuredLabelCustom}
                                                        onChange={(e) => setFeaturedLabelCustom(e.target.value)}
                                                        placeholder="Enter custom label"
                                                        className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                                    />
                                                )}
                                            </div>

                                            <div className="mb-4">
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Featured Player
                                                </label>
                                                <select
                                                    value={featuredPlayer}
                                                    onChange={(e) => setFeaturedPlayer(e.target.value)}
                                                    className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                                >
                                                    <option value="">Select featured player...</option>
                                                    {teamData.starters.map(player => (
                                                        <option key={player.name} value={player.name}>
                                                            {player.name}
                                                        </option>
                                                    ))}
                                                </select>
                                            </div>

                                            <div className="mb-4">
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Name Format
                                                </label>
                                                <select
                                                    value={nameFormat}
                                                    onChange={(e) => setNameFormat(e.target.value)}
                                                    className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                                >
                                                    <option value="full">Full Name</option>
                                                    <option value="surname">Surname Only</option>
                                                    <option value="initial">Initial. Surname</option>
                                                </select>
                                            </div>
                                        </React.Fragment>
                                    )}
                                </div>

                                {/* Right Column */}
                                <div>
                                    {teamData && (
                                        <React.Fragment>
                                            <div className="grid grid-cols-2 gap-4 mb-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                                        Kick-off Time
                                                    </label>
                                                    <input
                                                        type="text"
                                                        value={metadata.kickoff}
                                                        onChange={(e) => {
                                                            const ko = e.target.value;
                                                            let updates = {kickoff: ko};
                                                            // Auto-calculate meet time if empty
                                                            if (!metadata.meet_time && ko.match(/^\d{1,2}:\d{2}$/)) {
                                                                const [hours, mins] = ko.split(':').map(Number);
                                                                const meetHours = hours - 1;
                                                                if (meetHours >= 0) {
                                                                    updates.meet_time = `${meetHours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
                                                                }
                                                            }
                                                            setMetadata({...metadata, ...updates});
                                                        }}
                                                        className="w-full p-2 border border-gray-300 rounded-md"
                                                        placeholder="15:00"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                                        Meet Time
                                                    </label>
                                                    <input
                                                        type="text"
                                                        value={metadata.meet_time}
                                                        onChange={(e) => setMetadata({...metadata, meet_time: e.target.value})}
                                                        className="w-full p-2 border border-gray-300 rounded-md"
                                                        placeholder="13:30"
                                                    />
                                                </div>
                                            </div>

                                            <div className="mb-4">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                                    Location
                                                </label>
                                                <select
                                                    value={metadata.location}
                                                    onChange={(e) => setMetadata({...metadata, location: e.target.value})}
                                                    className="w-full p-2 border border-gray-300 rounded-md"
                                                >
                                                    <option value="">Select location...</option>
                                                    <option value="Sandbach RUFC, Bradwall Road, Sandbach. CW11 1RA">Sandbach RUFC (Home)</option>
                                                    <option value="Custom">Custom...</option>
                                                </select>
                                                {metadata.location === 'Custom' && (
                                                    <input
                                                        type="text"
                                                        value={metadata.custom_location || ''}
                                                        onChange={(e) => setMetadata({...metadata, custom_location: e.target.value})}
                                                        className="w-full p-2 border border-gray-300 rounded-md mt-2"
                                                        placeholder="Enter custom location"
                                                    />
                                                )}
                                            </div>

                                            <div className="mb-4">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                                    Custom Title
                                                </label>
                                                <input
                                                    type="text"
                                                    value={metadata.custom_title}
                                                    onChange={(e) => setMetadata({...metadata, custom_title: e.target.value})}
                                                    className="w-full p-2 border border-gray-300 rounded-md"
                                                    placeholder="Match Title"
                                                />
                                            </div>

                                            <div className="grid grid-cols-2 gap-4 mb-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                                        Match Date
                                                    </label>
                                                    <input
                                                        type="date"
                                                        value={metadata.match_date}
                                                        onChange={(e) => setMetadata({...metadata, match_date: e.target.value})}
                                                        className="w-full p-2 border border-gray-300 rounded-md"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                                        Kit / Post-Match
                                                    </label>
                                                    <select
                                                        value={kitText}
                                                        onChange={(e) => setKitText(e.target.value)}
                                                        className="w-full p-2 border border-gray-300 rounded-md"
                                                    >
                                                        <option value="Number 1s">Number 1's post match</option>
                                                        <option value="Polos">Polos and Chinos post match</option>
                                                        <option value="Custom">Custom...</option>
                                                    </select>
                                                </div>
                                            </div>

                                            {kitText === 'Custom' && (
                                                <div className="mb-4">
                                                    <textarea
                                                        value={kitTextCustom}
                                                        onChange={(e) => setKitTextCustom(e.target.value)}
                                                        placeholder="Enter custom kit/post-match info"
                                                        className="w-full p-2 border border-gray-300 rounded-md"
                                                        rows="3"
                                                    />
                                                </div>
                                            )}

                                            <button
                                                onClick={exportImage}
                                                disabled={!isFormValid()}
                                                className={`w-full py-2 px-4 rounded-md transition-colors ${isFormValid() ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-400 text-gray-200 cursor-not-allowed'}`}
                                            >
                                                Export as PNG
                                            </button>
                                        </React.Fragment>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Preview Panel - Full Width */}
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <div className="flex justify-between items-center mb-4 border-b pb-2">
                                <h2 className="text-xl font-semibold">Preview</h2>
                                {/* Tab Switcher */}
                                {teamData && (
                                    <div className="flex space-x-1 bg-gray-100 p-1 rounded-md">
                                        <button 
                                            onClick={() => setPreviewTab('sheet')}
                                            className={`px-3 py-1 text-sm font-medium rounded ${previewTab === 'sheet' ? 'bg-white text-gray-800 shadow' : 'text-gray-500 hover:text-gray-700'}`}
                                        >
                                            Team Sheet
                                        </button>
                                        <button 
                                            onClick={() => setPreviewTab('plan')}
                                            className={`px-3 py-1 text-sm font-medium rounded ${previewTab === 'plan' ? 'bg-white text-gray-800 shadow' : 'text-gray-500 hover:text-gray-700'}`}
                                        >
                                            Team Plan
                                        </button>
                                    </div>
                                )}
                            </div>

                            {loading ? (
                                <div className="flex items-center justify-center h-96">
                                    <div className="text-gray-500">Loading team data...</div>
                                </div>
                            ) : teamData ? (
                                <>
                                    {previewTab === 'sheet' && (
                                        <div className="flex justify-center overflow-auto bg-gray-50 p-4 border border-gray-200">
                                            <div id="capture-area" style={captureStyle}>
                                                <TeamSheetSVG 
                                                    data={teamData} 
                                                    featuredPlayer={featuredPlayer}
                                                    featuredImage={featuredImage}
                                                    metadata={metadata}
                                                    fixtureName={selectedWorksheet}
                                                    featuredLabelType={featuredLabelType}
                                                    featuredLabelCustom={featuredLabelCustom}
                                                    parseOpponent={parseOpponent}
                                                    nameFormat={nameFormat}
                                                    kitText={kitText}
                                                    kitTextCustom={kitTextCustom}
                                                    playerImages={playerImages}
                                                />
                                            </div>
                                        </div>
                                    )}
                                    {previewTab === 'plan' && (
                                        <TeamPlanTable periods={teamData.periods} templateType={teamData.template_type} />
                                    )}
                                </>
                            ) : (
                                <div className="flex items-center justify-center h-96">
                                    <div className="text-gray-500">Select a match to preview</div>
                                </div>
                            )}
                        </div>
                </div>
                )}
                {showEditModal && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-white p-6 rounded-lg w-full max-w-md shadow-xl">
                            <h3 className="text-lg font-bold mb-4 text-gray-900">Edit Match Details</h3>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Kickoff Time</label>
                                    <input type="text" value={editFormData.kickoff} onChange={handleKickoffChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm p-2 border" placeholder="15:00" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Meet Time</label>
                                    <input type="text" value={editFormData.meet_time} onChange={e => setEditFormData({...editFormData, meet_time: e.target.value})} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm p-2 border" placeholder="13:30" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Location</label>
                                    <input type="text" value={editFormData.location} onChange={e => setEditFormData({...editFormData, location: e.target.value})} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm p-2 border" />
                                </div>
                                <div className="flex items-center">
                                    <input type="checkbox" id="is_cancelled" checked={editFormData.is_cancelled} onChange={e => setEditFormData({...editFormData, is_cancelled: e.target.checked})} className="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded" />
                                    <label htmlFor="is_cancelled" className="ml-2 block text-sm text-gray-900">Match Cancelled</label>
                                </div>
                            </div>
                            <div className="mt-6 flex justify-end space-x-3">
                                <button onClick={() => setShowEditModal(false)} className="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                                <button onClick={handleSaveMatch} className="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">Save</button>
                            </div>
                        </div>
                    </div>
                )}
                </div>
            );
        }

        const POSITIONS = [
            { id: 1, label: '1', role: 'Loosehead Prop', cx: 30, cy: 18 },
            { id: 2, label: '2', role: 'Hooker', cx: 50, cy: 18 },
            { id: 3, label: '3', role: 'Tighthead Prop', cx: 70, cy: 18 },
            { id: 4, label: '4', role: '2nd Row', cx: 40, cy: 30 },
            { id: 5, label: '5', role: '2nd Row', cx: 60, cy: 30 },
            { id: 6, label: '6', role: 'Blindside Flanker', cx: 25, cy: 40 },
            { id: 7, label: '7', role: 'Openside Flanker', cx: 75, cy: 40 },
            { id: 8, label: '8', role: 'Number 8', cx: 50, cy: 45 },
            { id: 9, label: '9', role: 'Scrum Half', cx: 35, cy: 58 },
            { id: 10, label: '10', role: 'Fly Half', cx: 55, cy: 65 },
            { id: 11, label: '11', role: 'Left Wing', cx: 15, cy: 72 },
            { id: 12, label: '12', role: 'Inside Centre', cx: 40, cy: 75 },
            { id: 13, label: '13', role: 'Outside Centre', cx: 65, cy: 78 },
            { id: 14, label: '14', role: 'Right Wing', cx: 90, cy: 81 },
            { id: 15, label: '15', role: 'Full Back', cx: 50, cy: 92 }
        ];

        function TeamSheetSVG({ data, featuredPlayer, featuredImage, metadata, fixtureName, featuredLabelType, featuredLabelCustom, parseOpponent, nameFormat, kitText, kitTextCustom, playerImages }) {
            // Helper to format player name based on format option
            const formatName = (name, isCaptain = false) => {
                if (!name) return 'TBA';
                const parts = name.split(' ');
                let formatted;
                if (nameFormat === 'surname' && parts.length > 1) {
                    formatted = parts.slice(1).join(' ');
                } else if (nameFormat === 'initial' && parts.length > 1) {
                    formatted = parts[0].charAt(0) + '. ' + parts.slice(1).join(' ');
                } else {
                    formatted = name;
                }
                return formatted.toUpperCase() + (isCaptain ? ' (C)' : '');
            };

            // Style for match instructions text
            const matchInstructionsStyle = {
                color: '#FFD700',
                fontSize: '12px',
                fontWeight: 'bold',
                textAlign: 'center',
                wordWrap: 'break-word',
                lineHeight: '1.3',
                whiteSpace: 'pre-wrap'
            };
            const starters = data.starters || [];
            const finishers = data.finishers || [];
            const featuredName = featuredPlayer || (starters[9] ? starters[9].name : '') || 'The Team';
            
            const featuredNameStyle = {
                width: '100%',
                height: '100%',
                color: 'white',
                fontSize: '32px',
                fontWeight: '900',
                lineHeight: '1.0',
                textTransform: 'uppercase',
                overflowWrap: 'break-word',
                display: 'flex',
                alignItems: 'flex-start',
                paddingRight: '10px',
                fontFamily: 'sans-serif'
            };

            const finalLabel = (featuredLabelType === 'Custom' ? featuredLabelCustom : featuredLabelType) || 'FEATURED STAR';

            return (
                // Taller viewbox for extended pitch (1250px)
                <svg id="team-sheet-svg" className="team-sheet-svg" viewBox="0 0 1000 1250">
                    <defs>
                        <linearGradient id="pitchGrad" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0%" stopColor="#064e3b" />
                            <stop offset="100%" stopColor="#022c22" />
                        </linearGradient>

                        <pattern id="grassTexture" width="40" height="40" patternUnits="userSpaceOnUse">
                            <rect width="40" height="40" fill="transparent" />
                            <line x1="0" y1="0" x2="40" y2="0" stroke="rgba(255,255,255,0.02)" strokeWidth="1" />
                        </pattern>

                        <clipPath id="avatarCircle">
                            <circle cx="0" cy="0" r="28" />
                        </clipPath>
                        
                        <clipPath id="featuredAvatarClip">
                            <circle cx="60" cy="60" r="60" />
                        </clipPath>

                        <symbol id="silhouette" viewBox="-30 -30 60 60">
                          <circle cx="0" cy="-6" r="10" fill="rgba(255,255,255,0.15)" />
                          <path d="M-22,24 C-22,12 -12,8 0,8 C12,8 22,12 22,24 L-22,24 Z" fill="rgba(255,255,255,0.15)" />
                        </symbol>

                        <linearGradient id="headerOverlay" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0%" stopColor="rgba(0,0,0,0.5)" />
                            <stop offset="100%" stopColor="rgba(0,0,0,0)" />
                        </linearGradient>
                    </defs>

                    {/* Background fill for whole card */}
                    <rect width="1000" height="1250" fill="#022c22" />

                    {/* Pitch Background - Left Side - Extended Height */}
                    <rect width="750" height="1250" fill="url(#pitchGrad)" />
                    <rect width="750" height="1250" fill="url(#grassTexture)" />

                    {/* Field Markings - Scaled to fit 750px width and Extended Height */}
                    <g stroke="rgba(255,255,255,0.25)" strokeWidth="2" fill="none">
                        {/* Perimeter */}
                        <rect x="20" y="20" width="710" height="1210" strokeWidth="1" opacity="0.3" />

                        {/* Dead Ball Lines */}
                        <line x1="20" y1="80" x2="730" y2="80" strokeWidth="1" />
                        <line x1="20" y1="1170" x2="730" y2="1170" strokeWidth="1" />

                        {/* Try Lines */}
                        <line x1="20" y1="140" x2="730" y2="140" strokeWidth="3" />
                        <line x1="20" y1="1110" x2="730" y2="1110" strokeWidth="3" />

                        {/* 22m Lines */}
                        <line x1="20" y1="280" x2="730" y2="280" />
                        <line x1="20" y1="970" x2="730" y2="970" />

                        {/* 10m Lines (dashed) */}
                        <line x1="20" y1="360" x2="730" y2="360" strokeDasharray="10,10" />
                        <line x1="20" y1="890" x2="730" y2="890" strokeDasharray="10,10" />

                        {/* Halfway Line */}
                        <line x1="20" y1="625" x2="730" y2="625" strokeWidth="3" />

                        {/* 5m & 15m vertical markers based on 750 width */}
                        <g strokeDasharray="5,15" opacity="0.5">
                            <line x1="100" y1="140" x2="100" y2="1110" />
                            <line x1="220" y1="140" x2="220" y2="1110" />
                            <line x1="530" y1="140" x2="530" y2="1110" />
                            <line x1="650" y1="140" x2="650" y2="1110" />
                        </g>

                        {/* Center dashes */}
                        <line x1="355" y1="190" x2="395" y2="190" />
                        <line x1="355" y1="1060" x2="395" y2="1060" />
                    </g>

                    {/* Header Block - Full Width, Top Aligned */}
                    <rect width="1000" height="150" fill="#022c22" />
                    {/* Dark gradient overlay for header */}
                    <rect width="1000" height="150" fill="url(#headerOverlay)" />
                    <text x="40" y="45" fill="#FFD700" fontSize="14" fontWeight="800" letterSpacing="3">
                        {(metadata.custom_title || 'Match Day').toUpperCase()}
                    </text>
                    <text x="40" y="95" fontSize="52" fontWeight="900">
                        <tspan fill="#EE0000">Vs </tspan>
                        <tspan fill="white">{fixtureName ? parseOpponent(fixtureName).toUpperCase() : 'TEAM SHEET'}</tspan>
                    </text>

                    <g transform="translate(40, 125)">
                        <rect width="720" height="1" fill="rgba(255,255,255,0.2)" y="-15" />
                        {/* Date and Timing Row */}
                        <text x="0" y="10" fill="white" fontSize="12" fontWeight="bold">
                            {metadata.match_date ? new Date(metadata.match_date).toLocaleDateString('en-GB', {weekday: 'short', day: 'numeric', month: 'short', year: 'numeric'}).toUpperCase() : ''}
                        </text>
                        <text x="150" y="10" fill="white" fontSize="12" fillOpacity="0.9">
                            KO: {metadata.kickoff || 'TBC'}  |  MEET: {metadata.meet_time || 'TBC'}
                        </text>
                        {/* Location with icon */}
                        <g transform="translate(350, 0)">
                            <path d="M6 0C2.7 0 0 2.7 0 6c0 4.5 6 10 6 10s6-5.5 6-10c0-3.3-2.7-6-6-6zm0 8.5c-1.4 0-2.5-1.1-2.5-2.5S4.6 3.5 6 3.5s2.5 1.1 2.5 2.5S7.4 8.5 6 8.5z" fill="#10b981" transform="translate(0, 0) scale(1.2)"/>
                            <text x="18" y="10" fill="white" fontSize="12" fillOpacity="0.9">
                                {(metadata.location === 'Custom' ? (metadata.custom_location || 'TBC') : (metadata.location || 'TBC')).toUpperCase()}
                            </text>
                        </g>
                    </g>


                    {/* Team Layout - Shifted to center on narrower pitch */}
                    <g transform="translate(-25, 100)">
                        {POSITIONS.map((pos, idx) => {
                            const starter = starters[idx];
                            const playerName = starter ? starter.name : 'TBA';
                            const isFeatured = featuredPlayer && starter && starter.name === featuredPlayer;
                            
                            const playerImage = playerName && playerImages ? playerImages[playerName] : null;

                            const tx = pos.cx * 7.5; 
                            // Scaled vertical position for taller pitch
                            // Original cy was optimized for 800px height. layout ~0-100?
                            // Try scaling cy by 10.5 to spread out more
                            const ty = pos.cy * 10.5;

                            return (
                                <g key={pos.id} transform={`translate(${tx}, ${ty})`}>
                                    {isFeatured && (
                                        <circle r="38" fill="rgba(16, 185, 129, 0.4)" />
                                    )}

                                    <circle
                                        r="32"
                                        fill={isFeatured ? '#10b981' : 'rgba(15, 23, 42, 0.9)'}
                                        stroke={isFeatured ? 'white' : 'rgba(255,255,255,0.3)'}
                                        strokeWidth="2"
                                    />

                                    <g clipPath="url(#avatarCircle)">
                                        <rect x="-30" y="-30" width="60" height="60" fill="#0f172a" />
                                        {playerImage ? (
                                            <image href={playerImage} x="-30" y="-30" width="60" height="60" preserveAspectRatio="xMidYMid slice" />
                                        ) : (
                                            <use href="#silhouette" x="-30" y="-30" width="60" height="60" />
                                        )}
                                    </g>

                                    <circle cx="26" cy="-26" r="12" fill="white" stroke="#064e3b" strokeWidth="1" />
                                    <text x="26" y="-22" textAnchor="middle" fill="#064e3b" fontSize="10" fontWeight="900">
                                        {pos.label}
                                    </text>

                                    <g transform="translate(0, 48)">
                                        <rect
                                            x="-65"
                                            y="-16"
                                            width="130"
                                            height="32"
                                            rx="4"
                                            fill="rgba(0,0,0,0.85)"
                                            stroke={isFeatured ? '#10b981' : 'none'}
                                            strokeWidth="1"
                                        />
                                        <text
                                            textAnchor="middle"
                                            y="0"
                                            fill="white"
                                            fontSize="12"
                                            fontWeight="bold"
                                        >
                                            {formatName(playerName, featuredLabelType === 'Captain' && isFeatured)}
                                        </text>
                                        <text
                                            textAnchor="middle"
                                            y="12"
                                            fill="white"
                                            fontSize="8"
                                            fontWeight="900"
                                            letterSpacing="1"
                                        >
                                            {pos.role.toUpperCase()}
                                        </text>
                                    </g>
                                </g>
                            );
                        })}
                    </g>

                    {/* Finishers / Bench - Sidebar - Shifted Right */}
                    <g transform="translate(780, 180)">
                        <rect width="200" height="600" rx="8" fill="rgba(255,255,255,0.05)" />
                        <rect width="200" height="40" rx="8" fill="#022c22" />
                        {/* Dark gradient overlay for Finishers header */}
                        <rect width="200" height="40" rx="8" fill="url(#headerOverlay)" />
                        <text
                            x="100"
                            y="25"
                            textAnchor="middle"
                            fill="white"
                            fontSize="16"
                            fontWeight="900"
                            letterSpacing="2"
                        >
                            FINISHERS
                        </text>

                        {finishers.map((player, i) => {
                            if (!player.name) return null; // Hide empty slots
                            return (
                                <g key={player.name || i} transform={`translate(20, ${80 + i * 35})`}>
                                    <circle cx="10" cy="-4" r="14" fill="rgba(255,255,255,0.1)" />
                                    <text x="10" y="0" textAnchor="middle" fill="#10b981" fontSize="12" fontWeight="900">
                                        {i + 16}
                                    </text>
                                    <text x="35" y="0" fill="white" fontSize="13" fontWeight="bold">
                                        {formatName(player.name)}
                                    </text>
                                </g>
                            );
                        })}
                    </g>

                    {/* Match Instructions - Below Finishers, Above Featured */}
                    <foreignObject x="780" y="800" width="200" height="60">
                        <div xmlns="http://www.w3.org/1999/xhtml" style={matchInstructionsStyle}>
                            {kitText === 'Custom' ? kitTextCustom : (kitText === 'Number 1s' ? "Number 1's post match" : 'Polos and Chinos post match')}
                        </div>
                    </foreignObject>

                    {/* Featured footer - With Avatar - Adjusted for layout */}
                    <g transform="translate(780, 1065)">
                        {/* Avatar Image */}
                        <g transform="translate(40, -140)">
                             <circle cx="60" cy="60" r="64" fill="#10b981" />
                             <g clipPath="url(#featuredAvatarClip)">
                                {featuredImage ? (
                                    <image 
                                        href={featuredImage} 
                                        x="0" y="0" 
                                        width="120" 
                                        height="120" 
                                        preserveAspectRatio="xMidYMid slice"
                                    />
                                ) : (
                                    <use href="#silhouette" x="0" y="0" width="120" height="120" />
                                )}
                             </g>
                        </g>

                        <text x="0" y="40" fill="#FFD700" fontSize="12" fontWeight="900" letterSpacing="3">
                            {finalLabel.toUpperCase()}
                        </text>
                        
                        <foreignObject x="0" y="50" width="200" height="110">
                            <div style={featuredNameStyle}>
                                {featuredName}
                            </div>
                        </foreignObject>

                        <line x1="0" y1="165" x2="200" y2="165" stroke="#EE0000" strokeWidth="4" />
                        <line x1="0" y1="173" x2="200" y2="173" stroke="#FFD700" strokeWidth="4" />
                    </g>

                    {/* SRUFC Crest - Top Right */}
                    <image 
                        href="/static/pitch-assets/SRUFC Crest V2.svg" 
                        x="820" 
                        y="15" 
                        width="130" 
                        height="130" 
                        preserveAspectRatio="xMidYMid meet"
                    />
                </svg>
            );
        }

        ReactDOM.render(<TeamSheetApp />, document.getElementById('root'));
    </script>
</body>
</html>
